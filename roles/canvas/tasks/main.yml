#1 pre-installation
- name: Create User for Canvas
  user:
    name: canvas
    shell: /usr/sbin/nologin

- name: Ansible check file exists
  shell: if [ ! $(ls /data/wwwroot/knowage | grep Knowage.*.sh) ]; then echo "need_download";else echo "downloaded";fi
  register: result

- name: Download Knowage, it have 2G, need 10 minutes
  unarchive:
    src: "{{knowage_download_url}}"
    dest: "/data/wwwroot/knowage"
    remote_src: yes
    mode: 0750
  when: result.stdout == "need_download"

# install Canvas by OS_family
- name: Install this role on {{ansible_os_family}}
  include: "{{ansible_os_family}}.yml"

# configure Canvas
- block:
  - name: Configure Canvas
    shell: |
      for config in amazon_s3 delayed_jobs domain file_store outgoing_mail security external_migration; \
          do cp -v config/$config.yml.example config/$config.yml; done 
      cp config/dynamic_settings.yml.example config/dynamic_settings.yml
      bundle exec rails canvas:compile_assets
    args:
      chdir: canvas/

- block: 
  - name: SQL configure
    shell: | 
      cp config/database.yml.example config/database.yml
      createdb canvas_development


# set soft link, -f enforce the exist links
# ln -sf src des
#- name: set soft link
#  shell: |
    

# Check version,
# must use sudo sh -c to solve the no-root permission
#- block:
#  - name: Check Canvas Version
#    shell: sudo sh -c " 1>> /data/logs/install_version.txt"


# check service state
- name: Check Canvas Service
  shell: systemctl status canvas | grep Active*
  register: check_canvas_service
  notify: check_canvas_service
